---
title: "3_Fig3d_ATAC_nearby_gene_expression_pattern_add_GO"
author: "Qing Chen"
date: "03/12/2025"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: false
      smooth_scroll: false
---


## Goal:

ATAC cluster bearby gene expression pattern

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = './')

getwd()

```

# load library 
```{r}

library(ChIPseeker)
# human
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
txdb <- TxDb.Hsapiens.UCSC.hg19.knownGene

library(clusterProfiler)

library(org.Mm.eg.db)
# "org.Hs.eg.db"
library(ReactomePA)
# BiocManager::install("ggimage")
# install.packages("Rcpp")
library("ggupset")
library("ggplotify")
library("ggimage")


library(dplyr) # use select
library(tidyr)
library(ggplot2)

library(Hmisc)# in order to use capitalize
library('biomaRt')
human = useMart("ensembl", dataset = "hsapiens_gene_ensembl")

## in order to use reduce
library(purrr)
library("pheatmap")

```


```{r}
	plot_theme <-  theme_bw() +
		  theme(axis.line = element_line(colour = "black"),
		        panel.grid.major = element_blank(),
		        panel.grid.minor = element_blank(),
		        panel.border = element_blank(),
		        panel.background = element_blank(),
		        # title in the middle
		        plot.title = element_text(hjust = 0.5),
		        text = element_text(size = 15),axis.text = element_text(size = 15)) +theme(aspect.ratio = 1)

  box_theme <- theme_bw() +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        # title in the middle
        plot.title = element_text(hjust = 0.5)) 

```


#----- load 4 cluster of diff ATAC peaks


```{r}

diff_peak_list= list()

path <- "./"
temp<-read.delim(paste0(path,"DiffPeakClusters2/HL60_2d_specific_peaks.bed"),header = F)
colnames(temp) <- c("chr","start","end")
diff_peak_list[["2d"]] <- GRanges(temp)

temp <- read.delim(paste0(path,"DiffPeakClusters2/HL60_4h_specific_peaks.bed"),header = F)
colnames(temp) <- c("chr","start","end")
diff_peak_list[["4h"]]<-  GRanges(temp)

temp<- read.delim(paste0(path,"DiffPeakClusters2/HL60_Ctrl_specific_peaks.bed"),header = F)
colnames(temp) <- c("chr","start","end")
diff_peak_list[["Ctrl"]]<-  GRanges(temp)

temp<- read.delim(paste0(path,"DiffPeakClusters2/HL60_4d_specific_peaks.bed"),header = F)
colnames(temp) <- c("chr","start","end")
diff_peak_list[["4d"]]<-  GRanges(temp)

lapply(diff_peak_list, length)

```

# ------peak annotation to obtain bearby gene
```{r}
txdb <- TxDb.Hsapiens.UCSC.hg19.knownGene
peakAnnoList <- lapply(diff_peak_list, annotatePeak, TxDb=txdb, tssRegion=c(-1000, 1000), verbose=FALSE, annoDb="org.Hs.eg.db")
```


```{r}
ATAC_cluster_nearby_genes <- list()

for (n in names(peakAnnoList)){
  # n = names(peakAnnoList)[1]
  temp = as.data.frame(peakAnnoList[[n]])
  head(temp)
  ATAC_cluster_nearby_genes[[n]] <- temp$SYMBOL
  
  assign(paste0("genes_",n), temp$SYMBOL)
}

lapply(ATAC_cluster_nearby_genes, length)


```

```{r}
head(get("genes_2d"))
```

# ------ plot the ATAC_cluster_nearby_genes gene expression level 

## input the data 
```{r}

## all Gene data
df <- read.csv("./TPM.csv")

df <- dplyr::select(df,-X)
head(df)

df<-df[,-which(colnames(df)=="RA4h_1_TPM")] 

# just remove the _TPM to make the name shorter !!!
colnames(df)[2:dim(df)[2]] <- unlist(lapply(X = colnames(df)[2:dim(df)[2]],FUN = function(x) {return (strsplit(x,"_TPM")[[1]][1])}))

head(df)
```

##  manipulate the data for individual gene plot
```{r}

df_longer <-  df %>% tidyr::pivot_longer(cols = colnames(df)[-1], names_to = c("Condition","Replicates"),names_pattern= "(.*)_([1-9])", values_to= "TPM" ) %>% as.data.frame()
head(df_longer)
```

## define function
```{r}
gene_set_heatmap <- function(GeneSetName){
  # GeneSetName <- "TFs_Neu"
  GeneSet<- get(GeneSetName)
  df_temp <- df[which(df$Gene %in% GeneSet),]
  rownames(df_temp)<- df_temp$Gene

  df_temp<-df_temp[GeneSet,]

  row_keep <- apply(df_temp[,c(-1)], 1, function(x) !(sum(is.na(x)) | sum(is.infinite(x))) )
  df_temp = df_temp[row_keep, ]


	remove <- which(apply(df_temp[,c(-1)],1,var)== 0)

  if (length(remove) >1){
    print(dim(df_temp))
    df_temp <- df_temp[-remove,]
  	print(dim(df_temp))
  }
  df_temp <- df_temp[which(apply(df_temp[,c(-1)],1,var) != 0),]
 
	mtx <- as.matrix(df_temp[,c(-1)])
  rownames(mtx) <- df_temp$Gene
  head(mtx)
  
  mtx_colnames <-  colnames(df_temp[,c(-1)])
  mtx_colnames

  fun1 <- function(x) {return (substr(x,1,gregexpr(pattern ='_',x)[[1]][1]-1))}
  Conditions <- (unlist(lapply(mtx_colnames,fun1)))

  Sample_info <- data.frame(Conditions  = factor(Conditions,levels = c("Ctrl","RA4h","RA2d","RA4d")))


  rownames(Sample_info) <- mtx_colnames

  mtx_Zscore <- (mtx-apply(X = mtx, MARGIN = 1, mean))/apply(X = mtx, MARGIN = 1, sd)
  is.na(mtx_Zscore) %>% table()
  # kmeans cluster
  set.seed(2);mtx_kmeans <- kmeans(mtx_Zscore,centers=1,nstart = 25)

  gene_kmeans <- as.data.frame(sort(mtx_kmeans$cluster)); names(gene_kmeans) <- 'cluster';
  gene_kmeans$cluster <- factor(gene_kmeans$cluster)

  pheatmap(mtx_Zscore[names(sort(mtx_kmeans$cluster)),],cluster_rows=F,cluster_cols = F,angle_col='315',
           # annotation_row = gene_kmeans, 
           annotation_col = Sample_info,main = 'z-score (k-means)',show_rownames = F,fontsize_col=10,fontsize_row = 8,)

  
  mtx_Zscore<- as.data.frame(mtx_Zscore)
  
  mtx_Zscore[["Gene"]] <- rownames(mtx_Zscore)
  
  mtx_Zscore_long <- mtx_Zscore %>% pivot_longer(cols = colnames(mtx_Zscore)[1:(length(colnames(mtx_Zscore)) -1)], names_to = "Samples",values_to= "TPM_Zscore" ) %>% as.data.frame()
  
  fun1<- function(x) {return  (unlist(strsplit(x, "[_]"))[1])}
  mtx_Zscore_long$Samples<- unlist(lapply(mtx_Zscore_long$Samples,fun1))
  mtx_Zscore_long$Samples <-factor(Conditions,levels = c("Ctrl","RA4h","RA2d","RA4d"))
  
  head(mtx_Zscore_long)
  
  Median <- mtx_Zscore_long %>% dplyr::group_by(Samples) %>% dplyr::summarize(Median = median(TPM_Zscore))
  
  p <- ggplot(data =mtx_Zscore_long,aes(x = Samples,y = TPM_Zscore) )+ geom_boxplot() +labs(title = paste("Zscore \n",GeneSetName))+
      geom_point(data = Median, mapping = aes(x = Samples, y = Median)) +
      # , group=1 is necessary
    geom_line(data = Median, mapping = aes(x = Samples, y = Median, group=1),col = "red") + plot_theme
    
  print(p) 
  
}
```

## draw 

```{r}
names(ATAC_cluster_nearby_genes)
TFs<- c("Gata2","Irf8","Gfi1","Cebpa","Runx1","Lyl1","Plagl2","Ikzf1","Cebpe","Spi1","Cebpb")

TFs_Neu<-unique(unlist(lapply(X =TFs ,FUN= function(x) {return(toupper(x))})))
TFs_Neu

intrested_gene_sets <- c("TFs_Neu","genes_Ctrl","genes_4h","genes_2d","genes_4d")
for (GeneSetName in intrested_gene_sets){
  # GeneSetName = intrested_gene_sets[2]
  gene_set_heatmap(GeneSetName)
}
```

# ----------  GO analysis ---------- 

ClusterProfiler(ORA)---DiffPeak---GO and KEGG analysis


#### fun_ClusterProfiler_GO_KEGG_human
```{r}
## --2.-------Run GO and KEGG analysis -----------
fun_ClusterProfiler_GO_KEGG_human <- function(gene_ENTREZID,Gene){

  # gene_ENTREZID <- IDs
  #      1. GO analysis ----- enrichGO 
  ego_all <- enrichGO(gene = gene_ENTREZID,
                      # pay attention here----- use the correct ref
                      # OrgDb="org.Mm.eg.db",
                      OrgDb="org.Hs.eg.db",
                      ont='ALL',pAdjustMethod = 'BH',
                      pvalueCutoff = 1,  qvalueCutoff = 1,
                      # pvalueCutoff = 0.05, qvalueCutoff = 0.2,
                      keyType = 'ENTREZID')
  
  pdf_name <- paste(Gene,"_GO_KEGG_figures.pdf",sep ="_")
  pdf(pdf_name)
  # p_dot_GO <- dotplot(ego_all,showCategory=20,title =paste(Gene,"(GO)",sep =""))
  p_dot_GO <- enrichplot::dotplot(ego_all,showCategory=20,title =paste(Gene,"(GO)",sep =""),label_format = 35,font.size = 10)
  print(p_dot_GO)
  ego_all_sig <- ego_all[ego_all$pvalue <= 0.05]
  write.table(ego_all,file = paste(Gene,"GOenrich.txt",sep ="_"),sep = "\t")
  write.table(ego_all_sig,file = paste(Gene,"GOenrich_significant.txt",sep ="_"),sep = "\t")
  
  p_all<- read.table( paste(Gene,"GOenrich.txt",sep ="_"))
  p_all<-p_all[order(p_all$p.adjust),]
  dim(p_all)
  head(p_all)
  p_BP<-p_all[which(p_all[,1]== "BP"),]
  write.table(p_BP,file = paste(Gene,"BP_GOenrich.txt",sep ="_"),sep = "\t")
  p_CC<-p_all[which(p_all[,1]== "CC"),]
  write.table(p_CC,file = paste(Gene,"CC_GOenrich.txt",sep ="_"),sep = "\t")
  p_MF<-p_all[which(p_all[,1]== "MF"),]
  write.table(p_MF,file = paste(Gene,"MF_GOenrich.txt",sep ="_"),sep = "\t")
  ####    customize the bar plot 
  ## all term
  par(mar=c(4,20,2,2)+0.1)
  # down left up right
  barplot(rev(-log10(p_all$p.adjust[1:20]) ),horiz=TRUE,main = paste(Gene,"(GO)",sep = ""),col = "#0080CC",
          names.arg = rev(paste(p_all$Description,"(",p_all$Count,")",sep ="")[1:20]),las =1,
          xlim = c(0,max(rev(-log10(p_all$p.adjust[1:20]))+0.5)),
          xlab = "-log10(p.adjust)" )
  # paste(p_all$Description,"(",p_all$Count,")",sep ="")
  
  bar_plot_space <- seq(from =0,by = 0.2,length.out=20)
  x_pos <- rev(-log10(p_all$p.adjust[1:20]))+0.2
  y_pos = 1:20 + bar_plot_space
  ## padj = 0.05
  index <-which(x_pos>1.3)
  points(x= x_pos[index],y=y_pos[index],pch  = "*")
  
  ## BP CC MF term
  
  par(mar=c(4,20,2,2)+0.1)
  barplot(rev(-log10(p_BP$p.adjust[1:20]) ),horiz=TRUE,main = paste(Gene,"(BP)",sep = ""),col = "#0080CC",
          names.arg = rev(paste(p_BP$Description,"(",p_BP$Count,")",sep ="")[1:20]),las =1,
          xlim = c(0,max(rev(-log10(p_BP$p.adjust[1:20]))+0.5)),
          xlab = "-log10(p.adjust)")
  bar_plot_space <- seq(from =0,by = 0.2,length.out=20)
  x_pos <- rev(-log10(p_BP$p.adjust[1:20]))+0.2
  y_pos = 1:20 + bar_plot_space
  ## padj = 0.05
  index <-which(x_pos>1.3)
  points(x= x_pos[index],y=y_pos[index],pch  = "*")
  
  par(mar=c(4,20,2,2)+0.1)
  # down left up right
  barplot(rev(-log10(p_CC$p.adjust[1:20]) ),horiz=TRUE,main = paste(Gene,"(CC)",sep = ""),col = "#0080CC",
          names.arg = rev(paste(p_CC$Description,"(",p_CC$Count,")",sep ="")[1:20]),las =1,
          xlim = c(0,max(rev(-log10(p_CC$p.adjust[1:20]))+0.5)),
          xlab = "-log10(p.adjust)")
  bar_plot_space <- seq(from =0,by = 0.2,length.out=20)
  x_pos <- rev(-log10(p_CC$p.adjust[1:20]))+0.2
  y_pos = 1:20 + bar_plot_space
  ## padj = 0.05
  index <-which(x_pos>1.3)
  points(x= x_pos[index],y=y_pos[index],pch  = "*")
  
  par(mar=c(4,20,2,2)+0.1)
  # down left up right
  barplot(rev(-log10(p_MF$p.adjust[1:20]) ),horiz=TRUE,main = paste(Gene,"(MF)",sep = ""),col = "#0080CC",
          names.arg = rev(paste(p_MF$Description,"(",p_MF$Count,")",sep ="")[1:20]),las =1,
          xlim = c(0,max(rev(-log10(p_MF$p.adjust[1:20]))+0.5)),
          xlab = "-log10(p.adjust)")
  bar_plot_space <- seq(from =0,by = 0.2,length.out=20)
  x_pos <- rev(-log10(p_MF$p.adjust[1:20]))+0.2
  y_pos = 1:20 + bar_plot_space
  ## padj = 0.05
  index <-which(x_pos>1.3)
  points(x= x_pos[index],y=y_pos[index],pch  = "*")
  
  # 2. KEGG analysis  
  
  ekegg <- enrichKEGG(gene_ENTREZID, organism = 'hsa', keyType = 'kegg',
                      # -------------human : hsa  Rat:rno    Mouse:mmu-------------------
                      # pvalueCutoff = 0.05,qvalueCutoff = 0.2,
                      pvalueCutoff = 1,  qvalueCutoff = 1,
                      pAdjustMethod = 'BH', minGSSize = 10,maxGSSize = 500,
                      use_internal_data = FALSE)
  p_dot_KEGG<- dotplot(ekegg, showCategory=30,title = paste(Gene,"(KEGG)",sep = "") )
  print(p_dot_KEGG)
  
  dev.off()
}

```


#### Peaks associated genes


```{r}
diff_peak_gene_list <- list()

for (C in names(ATAC_cluster_nearby_genes)){
  diff_peak_gene_list[[C]] <- unique(as.data.frame(peakAnnoList[[C]])["geneId"])
}

lapply(diff_peak_gene_list, dim)

```

####  analysis 

```{r}
names(diff_peak_gene_list)
```

```{r}
names(ATAC_cluster_nearby_genes)
```

```{r}
for (C in names(diff_peak_gene_list)){
  cat(C,"\n")
  # fun_ClusterProfiler_GO_KEGG_mouse(diff_peak_gene_list[["C1_Tn"]]$geneId,"C1_Tn")
  fun_ClusterProfiler_GO_KEGG_human(diff_peak_gene_list[[C]]$geneId,C)

}
```

